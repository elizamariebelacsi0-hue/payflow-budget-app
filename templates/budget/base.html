{% load static %}
{% load budget_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PayFlow - Personal Budget Management & Bill Reminder App. Track expenses, manage payments, and never miss due dates.">
    <meta name="keywords" content="budget management, bill reminder, expense tracker, personal finance, payment tracker">
    <title>{% block title %}Payflow{% endblock %}</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Payflow helps users track budgets, bills, and payments with reminders.">
    <meta name="keywords" content="budget, bills, payments, reminders, financial management, expense tracker">
    <meta name="author" content="Payflow">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph Meta Tags for Social Media -->
    <meta property="og:title" content="Payflow">
    <meta property="og:description" content="Payflow helps users track budgets, bills, and payments with reminders.">
    <meta property="og:type" content="website">
    <meta property="og:image" content="/media/profile_pics/logo.1.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="Payflow Logo">
    
    <!-- Structured Data for Brand Logo -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "Payflow",
        "description": "Payflow helps users track budgets, bills, and payments with reminders.",
        "logo": "/media/profile_pics/logo.1.png",
        "url": "https://yourdomainname.com"
    }
    </script>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <link rel="icon"
     type="image/png" href="/media/profile_pics/logo.2.png">
    
    <style>
        @keyframes moneyFall {
            0% {
                transform: translateY(-20px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(300px) rotate(360deg);
                opacity: 0;
            }
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    {% if user.is_authenticated %}
    <!-- Top Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="{% url 'home' %}">
                <div class="brand-container">
                    <div class="logo-icon">
                         <img src="{% get_media_prefix %}profile_pics/logo.1.png" alt="₱ayflow Logo" width="40" height="40" style="border-radius: 50%; object-fit: cover;">
                    </div>
                    <span class="brand-text">₱ayflow</span>
                </div>
            </a>
            
            <div class="navbar-nav ms-auto d-flex align-items-center flex-nowrap">
                <!-- Search Bar -->
                <div class="me-2 position-relative d-none d-md-block flex-shrink-1">
                    <div class="input-group" style="width: 180px;">
                        <input type="text" class="form-control form-control-sm" placeholder="Search..." id="navSearchInput" style="border-radius: 20px 0 0 20px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;" onkeypress="if(event.key==='Enter') performSearch()">
                        <button class="btn btn-outline-light btn-sm" type="button" onclick="performSearch()" style="border-radius: 0 20px 20px 0; border: 1px solid rgba(255,255,255,0.3);">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <!-- Search Suggestions Dropdown -->
                    <div id="searchSuggestions" class="position-absolute" style="top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; display: none; max-height: 300px; overflow-y: auto;">
                        <div id="suggestionsList"></div>
                    </div>
                </div>
                <!-- Mobile Search Icon -->
                <div class="me-2 d-md-none flex-shrink-0">
                    <button class="btn btn-outline-light btn-sm" onclick="toggleMobileSearch()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>

                <div class="position-relative flex-shrink-0">
                    <a class="nav-link" href="#" id="notificationBtn" data-bs-toggle="modal" data-bs-target="#notificationModal">
                        <i class="fas fa-bell" style="color: white;"></i>
                        {% if due_soon %}
                        <span class="notification-badge">{{ due_soon|length }}</span>
                        {% endif %}
                    </a>
                </div>
            </div>
        </div>
    </nav>
    {% endif %}
    
    <!-- Main Content -->
    <div class="main-content">
        {% if messages %}
        <div class="container mt-3">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        {% block content %}{% endblock %}
    </div>
    
    {% if user.is_authenticated %}
    <!-- Notification Modal -->
    <div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notificationModalLabel">
                        <i class="fas fa-bell text-warning"></i> Payment Notifications
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="notificationModalBody">
                    <div id="notificationLoading" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading notifications...</p>
                    </div>
                    <div id="notificationContent">
                        {% if due_soon %}
                            <div class="notification-list">
                                {% for category in due_soon %}
                                <div class="notification-item {% if category.is_overdue %}overdue{% elif category.is_due_soon %}due-soon{% endif %}">
                                    <div class="notification-icon">
                                        {% if category.is_overdue %}
                                            <i class="fas fa-exclamation-triangle text-danger"></i>
                                        {% elif category.is_due_soon %}
                                            <i class="fas fa-clock text-warning"></i>
                                        {% endif %}
                                    </div>
                                    <div class="notification-content">
                                        <h6 class="notification-title">{{ category.name }}</h6>
                                        <p class="notification-details">
                                            Amount: {{ category.amount|peso_format }}<br>
                                            Due: {{ category.due_date|date:"M d, Y" }}
                                            {% if category.is_monthly %}
                                                <i class="fas fa-sync-alt" title="Monthly reminder"></i>
                                            {% endif %}
                                        </p>
                                        {% if category.is_overdue %}
                                            <span class="badge bg-danger">Overdue</span>
                                        {% elif category.is_due_soon %}
                                            <span class="badge bg-warning text-dark">Due Soon</span>
                                        {% endif %}
                                    </div>
                                    <div class="notification-actions">
                                        <a href="{% url 'category_detail' category.id %}" class="btn btn-sm btn-primary">
                                            <i class="fas fa-eye" style="color: white;"></i>
                                        </a>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                                <h6 class="mt-3">All caught up!</h6>
                                <p class="text-muted">No payments due soon.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="modal-footer">
            
                    <a href="{% url 'home' %}" class="btn btn-primary">View All Categories</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Unpaid Bills Modal -->
    <div class="modal fade" id="unpaidBillsModal" tabindex="-1" aria-labelledby="unpaidBillsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="unpaidBillsModalLabel">
                        <i class="fas fa-exclamation-triangle text-warning"></i> Unpaid Bills
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="unpaidBillsContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    
    <!-- Search Modal -->
    <div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="searchModalLabel">
                        <i class="fas fa-search"></i> Search Results
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="searchModalContent">
                    <!-- Search results will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payment Success Modal -->
    <div class="modal fade" id="paymentSuccessModal" tabindex="-1" aria-labelledby="paymentSuccessModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border: none; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);">
                <div class="modal-body text-center" style="position: relative; padding: 3rem;">
                    <div id="moneyAnimation" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; overflow: hidden;"></div>
                    <div style="position: relative; z-index: 10;">
                        <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                        <h3 class="mt-3 text-success fw-bold">Payment Successful!</h3>
                        <p class="text-muted">Your payment has been processed successfully.</p>
                        <button type="button" class="btn btn-success" data-bs-dismiss="modal">Continue</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payment Error Modal -->
    <div class="modal fade" id="paymentErrorModal" tabindex="-1" aria-labelledby="paymentErrorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center" style="padding: 3rem;">
                    <i class="fas fa-exclamation-triangle text-danger" style="font-size: 4rem;"></i>
                    <h3 class="mt-3 text-danger fw-bold">Payment Error</h3>
                    <p class="text-muted">Amount is not correct for the selected payment type.</p>
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Try Again</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if user.is_authenticated and request.resolver_match.url_name != 'welcome' %}
    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="container">
            <div class="row text-center">
                <div class="col-4">
                    <a class="nav-link {% if request.resolver_match.url_name == 'transactions' %}active{% endif %}" href="{% url 'transactions' %}">
                        <i class="fas fa-exchange-alt"></i>
                        <div class="small">Transactions</div>
                    </a>
                </div>
                <div class="col-4">
                    <a class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}" href="{% url 'home' %}">
                        <i class="fas fa-home"></i>
                        <div class="small">Home</div>
                    </a>
                </div>
                <div class="col-4">
                    <a class="nav-link {% if request.resolver_match.url_name == 'profile' %}active{% endif %}" href="{% url 'profile' %}">
                        <i class="fas fa-user"></i>
                        <div class="small">Profile</div>
                    </a>
                </div>
            </div>
        </div>
    </nav>
    {% endif %}
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script>
        // Toggle dashboard visibility
        function toggleDashboard() {
            const dashboard = document.getElementById('dashboard');
            if (dashboard) {
                dashboard.style.display = dashboard.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // Theme Functionality
        function toggleDarkMode() {
            const body = document.body;
            const darkModeToggle = document.getElementById('darkModeToggle');
            const blueThemeToggle = document.getElementById('blueThemeToggle');
            const greenThemeToggle = document.getElementById('greenThemeToggle');
            
            if (darkModeToggle && darkModeToggle.checked) {
                body.classList.add('dark-mode');
                body.classList.remove('blue-theme', 'green-theme');
                localStorage.setItem('darkMode', 'enabled');
                localStorage.setItem('blueTheme', 'disabled');
                localStorage.setItem('greenTheme', 'disabled');
                if (blueThemeToggle) blueThemeToggle.checked = false;
                if (greenThemeToggle) greenThemeToggle.checked = false;
            } else {
                body.classList.remove('dark-mode');
                localStorage.setItem('darkMode', 'disabled');
            }
        }

        function toggleBlueTheme() {
            const body = document.body;
            const blueThemeToggle = document.getElementById('blueThemeToggle');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const greenThemeToggle = document.getElementById('greenThemeToggle');
            
            if (blueThemeToggle && blueThemeToggle.checked) {
                body.classList.add('blue-theme');
                body.classList.remove('dark-mode', 'green-theme');
                localStorage.setItem('blueTheme', 'enabled');
                localStorage.setItem('darkMode', 'disabled');
                localStorage.setItem('greenTheme', 'disabled');
                if (darkModeToggle) darkModeToggle.checked = false;
                if (greenThemeToggle) greenThemeToggle.checked = false;
            } else {
                body.classList.remove('blue-theme');
                localStorage.setItem('blueTheme', 'disabled');
            }
        }

        function toggleGreenTheme() {
            const body = document.body;
            const greenThemeToggle = document.getElementById('greenThemeToggle');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const blueThemeToggle = document.getElementById('blueThemeToggle');
            
            if (greenThemeToggle && greenThemeToggle.checked) {
                body.classList.add('green-theme');
                body.classList.remove('dark-mode', 'blue-theme');
                localStorage.setItem('greenTheme', 'enabled');
                localStorage.setItem('darkMode', 'disabled');
                localStorage.setItem('blueTheme', 'disabled');
                if (darkModeToggle) darkModeToggle.checked = false;
                if (blueThemeToggle) blueThemeToggle.checked = false;
            } else {
                body.classList.remove('green-theme');
                localStorage.setItem('greenTheme', 'disabled');
            }
        }
        
        // Auto-hide notifications after 5 seconds
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                // Check for payment messages
                if (alert.textContent.includes('PAYMENT_SUCCESS')) {
                    alert.style.display = 'none'; // Hide the alert
                    showPaymentSuccessModal(); // Show success modal
                } else if (alert.textContent.includes('PAYMENT_ERROR')) {
                    alert.style.display = 'none'; // Hide the alert
                    showPaymentErrorModal(); // Show error modal
                } else {
                    setTimeout(function() {
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }, 5000);
                }
            });
            
            // Check for due soon notifications and show browser notification if supported
            if ('Notification' in window && Notification.permission === 'granted') {
                const dueSoonCount = document.querySelectorAll('.notification-badge').length;
                if (dueSoonCount > 0) {
                    new Notification('Payflow Payment Reminder', {
                        body: `You have ${dueSoonCount} payment(s) due soon!`,
                        icon: '/static/favicon.ico'
                    });
                }
            }
        });
        
        // Request notification permission
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }
        
        // Call this when user clicks notification bell
        document.addEventListener('DOMContentLoaded', function() {
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationModal = document.getElementById('notificationModal');
            
            if (notificationBtn) {
                notificationBtn.addEventListener('click', function() {
                    requestNotificationPermission();
                });
            }
            
            // Add loading state to notification modal
            if (notificationModal) {
                notificationModal.addEventListener('show.bs.modal', function() {
                    const loading = document.getElementById('notificationLoading');
                    const content = document.getElementById('notificationContent');
                    
                    // Show loading, hide content
                    loading.style.display = 'block';
                    content.style.display = 'none';
                    
                    // Simulate loading delay and show content
                    setTimeout(() => {
                        loading.style.display = 'none';
                        content.style.display = 'block';
                    }, 800);
                });
            }
            
            // Load theme preferences on all pages
            const savedDarkMode = localStorage.getItem('darkMode');
            const savedBlueTheme = localStorage.getItem('blueTheme');
            const savedGreenTheme = localStorage.getItem('greenTheme');
            
            if (savedDarkMode === 'enabled') {
                document.body.classList.add('dark-mode');
                const darkModeToggle = document.getElementById('darkModeToggle');
                if (darkModeToggle) darkModeToggle.checked = true;
            } else if (savedBlueTheme === 'enabled') {
                document.body.classList.add('blue-theme');
                const blueThemeToggle = document.getElementById('blueThemeToggle');
                if (blueThemeToggle) blueThemeToggle.checked = true;
            } else if (savedGreenTheme === 'enabled') {
                document.body.classList.add('green-theme');
                const greenThemeToggle = document.getElementById('greenThemeToggle');
                if (greenThemeToggle) greenThemeToggle.checked = true;
            }
            
            
            // Load recent searches from localStorage
            function loadRecentSearches() {
                const recent = JSON.parse(localStorage.getItem('recentSearches') || '[]');
                if (recent.length > 0) {
                    recentSearches.style.display = 'block';
                    recentList.innerHTML = recent.map(term => 
                        `<div class="recent-item" onclick="searchTerm('${term}')">${term}</div>`
                    ).join('');
                } else {
                    recentSearches.style.display = 'none';
                }
            }
            
            // Save search term to recent searches
            function saveRecentSearch(term) {
                const recent = JSON.parse(localStorage.getItem('recentSearches') || '[]');
                if (!recent.includes(term)) {
                    recent.unshift(term);
                    if (recent.length > 5) {
                        recent.pop();
                    }
                    localStorage.setItem('recentSearches', JSON.stringify(recent));
                }
            }
            
            // Clear recent searches
            function clearRecentSearches() {
                localStorage.removeItem('recentSearches');
                recentSearches.style.display = 'none';
            }
            
            // Search for suggestions
            function searchSuggestions(query) {
                console.log('Searching for:', query);
                if (query.length < 1) {
                    searchSuggestions.style.display = 'none';
                    return;
                }
                
                fetch(`/search-suggestions/?q=${encodeURIComponent(query)}`)
                    .then(response => {
                        console.log('Response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Search results:', data);
                        if (data.results && data.results.length > 0) {
                            suggestionsList.innerHTML = data.results.map(result => `
                                <div class="suggestion-item" onclick="navigateToResult('${result.url}')">
                                    <div class="suggestion-icon">
                                        <i class="${result.icon}"></i>
                                    </div>
                                    <div class="suggestion-content">
                                        <div class="suggestion-name">${result.name}</div>
                                        <div class="suggestion-type">${result.type} • ${result.page_location || 'Application'}</div>
                                    </div>
                                </div>
                            `).join('');
                            searchSuggestions.style.display = 'block';
                            viewAllResultsBtn.href = `/search/?q=${encodeURIComponent(query)}`;
                            viewAllResultsBtn.style.display = 'inline-block';
                        } else {
                            searchSuggestions.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Search error:', error);
                        searchSuggestions.style.display = 'none';
                    });
            }
            
            // Navigate to search result
            function navigateToResult(url) {
                window.location.href = url;
            }
            
            // Search for a term
            function searchTerm(term) {
                searchInput.value = term;
                searchSuggestions(term);
            }
            
            // Event listeners
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    const query = this.value.trim();
                    
                    if (query.length >= 1) {
                        searchTimeout = setTimeout(() => {
                            searchSuggestions(query);
                        }, 300);
                    } else {
                        searchSuggestions.style.display = 'none';
                        loadRecentSearches();
                    }
                });
                
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const query = this.value.trim();
                        if (query) {
                            saveRecentSearch(query);
                            window.location.href = `/search/?q=${encodeURIComponent(query)}`;
                        }
                    }
                });
            }
            
            // Search submit button
            const searchSubmitBtn = document.getElementById('searchSubmitBtn');
            if (searchSubmitBtn) {
                searchSubmitBtn.addEventListener('click', function() {
                    const query = searchInput.value.trim();
                    if (query) {
                        saveRecentSearch(query);
                        window.location.href = `/search/?q=${encodeURIComponent(query)}`;
                    }
                });
            }
            
            // Clear recent searches button
            const clearRecentBtn = document.getElementById('clearRecentBtn');
            if (clearRecentBtn) {
                clearRecentBtn.addEventListener('click', function() {
                    clearRecentSearches();
                });
            }
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.position-relative') && !e.target.closest('#searchSuggestions')) {
                    hideSuggestions();
                }
            });
            
            // Load recent searches when modal opens
            const searchModal = document.getElementById('searchModal');
            if (searchModal) {
                searchModal.addEventListener('shown.bs.modal', function() {
                    loadRecentSearches();
                    searchInput.focus();
                });
                
                searchModal.addEventListener('hidden.bs.modal', function() {
                    searchInput.value = '';
                    searchSuggestions.style.display = 'none';
                    viewAllResultsBtn.style.display = 'none';
                });
            }
        });
        
        
        // Search functionality
        function performSearch() {
            const searchInput = document.getElementById('navSearchInput');
            const query = searchInput.value.trim();
            console.log('performSearch called with:', query);
            if (query) {
                hideSuggestions();
                openSearchModal(query);
            }
        }
        
        function openSearchModal(query) {
            const modal = new bootstrap.Modal(document.getElementById('searchModal'));
            const content = document.getElementById('searchModalContent');
            
            content.innerHTML = '<div class="text-center py-4"><div class="spinner-border" role="status"></div></div>';
            modal.show();
            
            fetch(`/search-suggestions/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    let html = `<h6 class="mb-3">Search Results for "${query}"</h6>`;
                    
                    if (data.results && data.results.length > 0) {
                        html += '<div class="list-group">';
                        data.results.forEach(result => {
                            html += `
                                <div class="list-group-item list-group-item-action" style="cursor: pointer;" onclick="navigateToResult('${result.url}')">
                                    <div class="d-flex align-items-center">
                                        <i class="${result.icon} me-3 text-primary"></i>
                                        <div>
                                            <h6 class="mb-1">${result.name}</h6>
                                            <small class="text-muted">${result.type} • ${result.details}</small>
                                        </div>
                                        <i class="fas fa-chevron-right ms-auto text-muted"></i>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    } else {
                        html += '<div class="text-center py-4"><i class="fas fa-search fa-2x text-muted mb-2"></i><p>No results found</p></div>';
                    }
                    
                    content.innerHTML = html;
                })
                .catch(error => {
                    content.innerHTML = '<div class="text-center py-4 text-danger">Error loading results</div>';
                });
        }
        
        function filterCategories(query) {
            const categories = document.querySelectorAll('.category-item');
            const lowerQuery = query.toLowerCase();
            let visibleCount = 0;
            
            categories.forEach(category => {
                const categoryName = category.querySelector('.category-name')?.textContent.toLowerCase() || '';
                const categoryType = category.querySelector('.category-type')?.textContent.toLowerCase() || '';
                
                if (categoryName.includes(lowerQuery) || categoryType.includes(lowerQuery)) {
                    category.style.display = 'block';
                    visibleCount++;
                } else {
                    category.style.display = 'none';
                }
            });
            
            // Show/hide no results message
            let noResultsMsg = document.getElementById('noSearchResults');
            if (visibleCount === 0) {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.id = 'noSearchResults';
                    noResultsMsg.className = 'text-center text-muted py-4';
                    noResultsMsg.innerHTML = `<i class="fas fa-search"></i><br>No categories found for "${query}"`;
                    document.querySelector('.categories-section').appendChild(noResultsMsg);
                }
            } else if (noResultsMsg) {
                noResultsMsg.remove();
            }
        }
        
        // Search functionality variables
        let searchTimeout;
        
        function showSuggestions(query) {
            console.log('showSuggestions called with:', query);
            if (query.length < 1) {
                hideSuggestions();
                return;
            }
            
            // Show loading state
            const suggestionsList = document.getElementById('suggestionsList');
            const suggestionsContainer = document.getElementById('searchSuggestions');
            suggestionsList.innerHTML = '<div class="p-2 text-center"><div class="spinner-border spinner-border-sm" role="status"></div> <span class="ms-2">Searching...</span></div>';
            suggestionsContainer.style.display = 'block';
            
            console.log('Fetching suggestions for:', query);
            fetch(`/search-suggestions/?q=${encodeURIComponent(query)}`)
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Search data received:', data);
                    // Add slight delay to show loading state
                    setTimeout(() => {
                        const suggestionsList = document.getElementById('suggestionsList');
                        const suggestionsContainer = document.getElementById('searchSuggestions');
                    
                    if (data.results && data.results.length > 0) {
                        suggestionsList.innerHTML = data.results.map(result => `
                            <div class="suggestion-item p-2 border-bottom" style="cursor: pointer; color: #333;" onclick="navigateToSuggestion('${result.url}')" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='white'">
                                <div class="d-flex align-items-center">
                                    <i class="${result.icon} me-2" style="color: #6c757d;"></i>
                                    <div>
                                        <div class="fw-bold">${result.name}</div>
                                        <small class="text-muted">${result.type} • ${result.details}</small>
                                    </div>
                                    <i class="fas fa-chevron-right ms-auto text-muted"></i>
                                </div>
                            </div>
                        `).join('');
                        suggestionsContainer.style.display = 'block';
                        console.log('Suggestions displayed');
                    } else {
                        suggestionsList.innerHTML = '<div class="p-2 text-muted text-center">No results found</div>';
                        suggestionsContainer.style.display = 'block';
                        console.log('No results found');
                    }
                    }, 300); // 300ms delay to show loading
                })
                .catch(error => {
                    console.error('Search error:', error);
                    hideSuggestions();
                });
        }
        
        function hideSuggestions() {
            document.getElementById('searchSuggestions').style.display = 'none';
        }
        
        function navigateToResult(url) {
            // Close modal first
            const modal = bootstrap.Modal.getInstance(document.getElementById('searchModal'));
            if (modal) {
                modal.hide();
            }
            // Navigate after modal closes
            setTimeout(() => {
                window.location.href = url;
            }, 300);
        }
        
        function navigateToSuggestion(url) {
            // Hide suggestions dropdown
            hideSuggestions();
            // Clear search input
            document.getElementById('navSearchInput').value = '';
            
            // Handle JavaScript URLs for month bills
            if (url.startsWith('javascript:')) {
                eval(url.substring(11)); // Remove 'javascript:' and execute
            } else {
                // Navigate to regular URLs
                window.location.href = url;
            }
        }
        
        // Enhanced search input event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('navSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    const query = this.value.trim();
                    
                    if (query === '') {
                        hideSuggestions();
                    } else {
                        searchTimeout = setTimeout(() => {
                            showSuggestions(query);
                        }, 300);
                    }
                });
                
                // Removed blur event to fix double-tap issue
                
                searchInput.addEventListener('focus', function() {
                    const query = this.value.trim();
                    if (query) {
                        showSuggestions(query);
                    }
                });
            }
        });
        
        // Mobile search toggle
        function toggleMobileSearch() {
            const searchBar = document.querySelector('.d-none.d-md-block');
            if (searchBar) {
                searchBar.classList.toggle('d-none');
                searchBar.classList.toggle('d-block');
                if (!searchBar.classList.contains('d-none')) {
                    document.getElementById('navSearchInput').focus();
                }
            }
        }
        
        function showPaymentSuccessModal() {
            const modal = new bootstrap.Modal(document.getElementById('paymentSuccessModal'));
            const animationContainer = document.getElementById('moneyAnimation');
            
            // Clear previous animations
            animationContainer.innerHTML = '';
            
            // Create money falling animation
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const money = document.createElement('span');
                    money.textContent = '₱';
                    money.style.cssText = `
                        position: absolute;
                        left: ${Math.random() * 100}%;
                        top: -20px;
                        font-size: ${Math.random() * 1 + 1}rem;
                        color: #28a745;
                        animation: moneyFall 3s linear forwards;
                        pointer-events: none;
                    `;
                    animationContainer.appendChild(money);
                    
                    // Remove element after animation
                    setTimeout(() => {
                        if (money.parentNode) {
                            money.parentNode.removeChild(money);
                        }
                    }, 3000);
                }, i * 200);
            }
            
            modal.show();
        }
        
        function showPaymentErrorModal() {
            const modal = new bootstrap.Modal(document.getElementById('paymentErrorModal'));
            modal.show();
        }
        
        function viewUnpaidBills(month) {
            const modal = new bootstrap.Modal(document.getElementById('unpaidBillsModal'));
            const content = document.getElementById('unpaidBillsContent');
            
            content.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            
            modal.show();
            
            fetch(`/unpaid-bills/${month}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.unpaid_bills && data.unpaid_bills.length > 0) {
                        content.innerHTML = `
                            <h6 class="mb-3">${data.month_name} Unpaid Bills</h6>
                            <div class="notification-list">
                                ${data.unpaid_bills.map(bill => `
                                    <div class="notification-item ${bill.status === 'overdue' ? 'overdue' : 'due-soon'}">
                                        <div class="notification-icon">
                                            ${bill.status === 'overdue' ? 
                                                '<i class="fas fa-exclamation-triangle text-danger"></i>' : 
                                                '<i class="fas fa-clock text-warning"></i>'
                                            }
                                        </div>
                                        <div class="notification-content">
                                            <h6 class="notification-title">${bill.name}</h6>
                                            <p class="notification-details">
                                                Amount: ₱${bill.amount.toLocaleString()}<br>
                                                Due: ${bill.due_date}<br>
                                                Type: ${bill.category_type}
                                                ${bill.is_monthly ? '<i class="fas fa-sync-alt" title="Monthly reminder"></i>' : ''}
                                            </p>
                                            ${bill.status === 'overdue' ? 
                                                '<span class="badge bg-danger">Overdue</span>' : 
                                                '<span class="badge bg-warning text-dark">Due Soon</span>'
                                            }
                                        </div>
                                        <div class="notification-actions">
                                            <a href="/category/${bill.id}/" class="btn btn-sm btn-primary">
                                                <i class="fas fa-eye" style="color: white;"></i>
                                            </a>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        content.innerHTML = `
                            <div class="text-center py-4">
                                <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                                <h6 class="mt-3">No unpaid bills!</h6>
                                <p class="text-muted">All bills for ${data.month_name} are up to date.</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error fetching unpaid bills:', error);
                    content.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                            <h6 class="mt-3">Error loading bills</h6>
                            <p class="text-muted">Please try again later.</p>
                        </div>
                    `;
                });
        }
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
